# IPSEC
IPsec（Internet Protocol Security）是一组用于在互联网协议（IP）网络上提供安全性的协议和相关技术。其主要目标是确保网络通信的机密性、完整性和身份验证。IPsec通常用于保护IP层上的数据传输，提供端到端的安全性。
## IPSEC的功能
1. **机密性（Confidentiality）：** 通过使用加密算法，IPsec可以保护数据的隐私，防止未经授权的访问者读取传输的信息。加密算法通常用于加密IPsec通信中的数据负载。
2. **完整性（Integrity）：** IPsec通过使用完整性校验和哈希算法来确保数据在传输过程中未被篡改。这样可以防止中间人攻击或数据篡改。
3. **身份验证（Authentication）：** IPsec支持对通信双方的身份进行验证，以确保通信的各方是合法的。身份验证通常使用数字签名或共享密钥来实现。
4. **防重放攻击（Replay Protection）：** IPsec使用序列号来防范重放攻击。每个IPsec报文都有一个唯一的序列号，接收方使用这个序列号来检测和拒绝已经收到的报文。`保证每次交换的数据都是不同的`
## IPsec组成：
1. **AH（Authentication Header）：** AH协议提供完整性和身份验证服务。它使用哈希函数对数据进行摘要，并在IP报文中添加认证数据。AH可以在不加密数据的情况下提供安全性。

2. **ESP（Encapsulating Security Payload）：** ESP协议提供机密性、完整性和可选的身份验证服务。它通过在IP报文中封装原始数据来加密数据。ESP可以单独使用，也可以与AH结合使用。
IPsec通常在虚拟专用网络（VPN）和用于远程访问的安全性通信中广泛应用。通过在网络层实施安全性，IPsec可以保护整个通信链路，而不仅仅是特定的应用程序或服务。
## 运行模式
IPsec（Internet Protocol Security）提供了两种工作模式，分别是传输模式（Transport Mode）和隧道模式（Tunnel Mode）。这两种模式用于在IP网络上保护通信的机密性和完整性，但它们对IP报文的处理方式略有不同。
### 1. 传输模式（Transport Mode）:
- **特点：**
  - 适用于端对端的通信，即通信双方的终端设备之间。
  - 保护的是IP数据包的载荷（数据部分），而不是整个IP包。
  - 通常用于点对点的通信，例如主机到主机的通信。
- **对IP报文的更改：**
  - 仅对IP数据包的载荷（IP头部之后的部分）进行加密和认证，而不改变IP头部。
  - 对原始IP数据包的更改很少，只有在进行加密和认证的情况下`引入了一些额外的字段。`
### 2. 隧道模式（Tunnel Mode）:
- **特点：**
  - 适用于网络到网络之间的通信，即两个网络之间的通信。
  - 不仅保护IP数据包的载荷，还对整个IP包（包括IP头部）进行加密和认证。
  - 常用于创建虚拟私人网络（VPN），将两个远程网络通过加密隧道连接起来。
- **对IP报文的更改：**
  - 对整个IP包（包括IP头部和载荷）进行加密和认证。
  - `引入了新的IP头部，新的IP头部用于封装原始的IP数据包。这个新的IP头部包含了加密后的信息以及用于传输的目标地址。`
在两种工作模式下，IPsec使用安全关联（Security Association，SA）来管理加密和认证算法、密钥等信息。无论是传输模式还是隧道模式，IPsec都能提供机密性、完整性和身份验证，以确保通信的安全性。
## 安全关联（Security Association，SA）
IPsec中的安全关联（Security Association，SA）是一组规则和信息，定义了两个端点之间进行安全通信所需的参数。每个SA都唯一标识了一条安全连接，并确定了如何在该连接上保护通信。IPsec的两个主要协议，AH（Authentication Header）和ESP（Encapsulating Security Payload），都使用SA来提供安全性。

以下是关于IPsec安全关联的一些关键点：
1. **唯一标识：** 每个IPsec SA都有一个唯一标识符，称为SA标识（SA ID）。SA ID用于区分不同的安全关联。
2. **协议和模式：** SA定义了要使用的IPsec协议（AH、ESP）和加密/认证算法。它还指定了如何使用这些算法，例如使用哪种模式（传输模式或隧道模式）。
3. **密钥：** SA包括用于加密和认证的密钥。这些密钥由IKE（Internet Key Exchange）协议协商而来，确保通信的双方都具有相同的密钥。
4. **生命周期：** SA有一个生命周期，包括创建、使用和终止。生命周期参数包括SA的有效期限和使用次数，以及是否允许自动重新协商新的SA。
5. **流量选择器：** SA定义了哪些网络流量将受到保护，称为流量选择器。流量选择器通常由IP地址、协议和端口等参数组成。
6. **安全性策略：** SA还包括关于如何处理受保护流量的其他策略信息，例如是否压缩、是否启用防重放攻击保护等。
7. **入站和出站规则：** SA可用于定义入站和出站规则，以确定对于受保护的通信，应该如何进行加密、认证等处理。
在通信双方之间的IPsec连接中，通常会存在多个SA，每个SA可能用于不同的流量选择器、不同的协议、不同的算法等。SA的维护和管理是由IKE负责的，它在协商阶段（IKE Phase 1和Phase 2）期间协商这些参数并建立SA。安全关联的创建和终止通常发生在运行时，以适应网络动态性和安全需求的变化。
## IPSec VPN
建立IPSec/IKE VPN流程如下
1. 主机或网关B向远程主机或网关A发送VPN建立请求
2. A产生一个随机数，并将其发送给B
3. B使用这个随机数加密预先通过IKE分享的密钥，将结果发送给A
4. A也用该随机数将B发来的结果解密，与预先分享的密钥比较，如果匹配，则使用这个密钥加密公钥，发送给B
5. B使用该公钥来建立它与A之间的IPSec SA，VPN隧道建立